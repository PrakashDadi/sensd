{% extends 'base.html' %}
{% block content %}

<!-- STYLES -->
<style>
    .table th,
    .table td { text-align: justify; vertical-align: middle; white-space: nowrap; }
    .table thead th { text-transform: uppercase; font-size: 0.95rem; }
    .section-title { font-size: 1.3rem; font-weight: 600; text-transform: uppercase; text-align: center; margin: 30px 0 15px 0; }

    /* Chart wrapper */
    .chart-container { position: relative; width: 100%; max-width: 100%; height: 360px; margin-top: 20px; }
    .chart-container canvas { width: 100% !important; height: 100% !important; }

    /* Action buttons (match collapse header style) */
    .chart-action-btn { margin-left: .25rem; margin-bottom: .5rem; }
</style>

<div class="container">
    <!-- HEADER -->
    <header class="theme-banner text-center py-5 mb-4 shadow-lg border-bottom border-success">
        <div class="container">
            <h1 class="display-4 fw-bold text-uppercase" style="letter-spacing: 2px;">SENSD Results Dashboard</h1>
            <p class="lead subtext mt-2">Visualize & Explore Optimization Outputs with Confidence</p>
        </div>
    </header>

    <!-- CARD -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
            <h5 class="mb-0 text-uppercase text-start fw-bold">Result - {{ result_id }}</h5>
            <div class="text-end">
                <label class="text-muted small fw-semibold d-block">System‑wide Reliability</label>
                <div class="progress" style="height: 20px; width: 200px;">
                    <div id="reliability-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span id="reliability-value" class="badge bg-success mt-1"></span>
            </div>
        </div>

        <div class="card-body">
            <!-- NODE SECTION -->
            <h3 class="section-title">Node Values</h3>
            <div class="mb-2">
                <button class="btn btn-sm btn-outline-secondary chart-action-btn toggle-chart-btn" data-target="node">Show Chart</button>
                <button class="btn btn-sm btn-outline-secondary chart-action-btn toggle-dist-btn d-none" data-target="node">Show Distribution</button>
            </div>
            <div class="table-responsive view-node-table mb-3">
                <table id="node-table" class="table table-bordered table-striped">
                    <thead class="table-success">
                        <tr><th>Node ID</th><th>Direct Cost</th><th>Cumulative Cost</th><th>Demand Rate</th><th>Lead Time</th></tr>
                    </thead><tbody id="node-table-body"></tbody>
                </table>
            </div>
            <div class="chart-container d-none view-node-chart"><canvas id="chart-node-cost"></canvas></div>

            <!-- VARIABLES -->
            <h3 class="section-title">Variable Results</h3>
            <div id="variable-tables"></div>

            <div class="text-center mt-4"><a href="{% url 'sensd' %}" class="btn btn-primary">Back to Dashboard</a></div>
        </div>
    </div>
</div>

<!-- DATA -->
<script type="application/json" id="table-data">{{ table_data|safe }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tableData = JSON.parse(document.getElementById('table-data').textContent);

    // PALETTE
    const palette = ['#20c997','#ff6b6b','#f9c80e','#00b3ff','#845ef7','#f9813a','#12c2e9','#c471ed','#f64f59'];

    /* ------------------ SYSTEM RELIABILITY ------------------- */
    const sysRel = parseFloat(tableData.variables?.['System-wide Reliability']?.[0]?.Value || 0);
    const relBar = document.getElementById('reliability-bar');
    const relVal = document.getElementById('reliability-value');
    const percent = Math.round(sysRel*100);
    relBar.style.width = `${percent}%`;
    relBar.setAttribute('aria-valuenow',percent);
    relVal.textContent = `${percent}%`;

    /* ------------------ NODE TABLE & CHART ------------------- */
    const nodeLabels=[], nodeCum=[];
    const nodeBody=document.getElementById('node-table-body');
    tableData.nodes.forEach(n=>{
        nodeBody.insertAdjacentHTML('beforeend',`<tr><td>${n['Node ID']}</td><td>${n['Direct Cost']}</td><td>${n['Cumulative Cost']}</td><td>${n['Demand Rate']}</td><td>${n['Lead Time']}</td></tr>`);
        nodeLabels.push(n['Node ID']);
        nodeCum.push(parseFloat(n['Cumulative Cost'])||0);
    });
    new DataTable('#node-table',{dom:'frtip',pageLength:8});
    new Chart(document.getElementById('chart-node-cost').getContext('2d'),{
        type:'bar', data:{labels:nodeLabels, datasets:[{label:'Cumulative Cost',data:nodeCum,backgroundColor:palette[0]}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:true}} ,scales:{y:{beginAtZero:true}}}
    });

    /* ------------------ VARIABLE SECTIONS ------------------- */
    const colors = {"Pathogen Testing":'table-success',"Testing Method Selection":'table-info',"Node Controllability":'table-warning',"Direct Cost":'table-danger',"Lead Time":'table-primary',"Sensitivity":'table-secondary',"Reliability":'table-light',"Inbound Reliability":'table-dark',"System-wide Reliability":'table-success'};
    const container=document.getElementById('variable-tables');
    let order=0;

    // DELEGATED TOGGLES
    document.body.addEventListener('click',e=>{
        if(e.target.classList.contains('toggle-chart-btn')){
            const id=e.target.dataset.target; const chart=document.querySelector(`.view-${id}-chart`);
            chart.classList.toggle('d-none');
            e.target.textContent=chart.classList.contains('d-none')?'Show Chart':'Hide Chart';
        }
        if(e.target.classList.contains('toggle-dist-btn')){
            const id=e.target.dataset.target; const dist=document.querySelector(`.view-${id}-dist`);
            dist.classList.toggle('d-none');
            e.target.textContent=dist.classList.contains('d-none')?'Show Distribution':'Hide Distribution';
        }
    });

    const boolGroups=["Pathogen Testing","Node Controllability","Testing Method Selection"];

    for(const group in tableData.variables){
        const entries=tableData.variables[group];
        const isBool=entries.every(e=>e.Value===0||e.Value===1);
        const isTMS=group==='Testing Method Selection';
        const idSafe=group.replace(/\s+/g,'-').toLowerCase();

        /* ------- HEADER & BUTTONS ------- */
        let html=`<div class="mt-4">
            <button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${idSafe}" aria-expanded="true">${group.toUpperCase()}</button>
            <button class="btn btn-sm btn-outline-secondary chart-action-btn toggle-chart-btn" data-target="${idSafe}">Show Chart</button>`;
        if(isBool && boolGroups.includes(group)){
            html+=`<button class="btn btn-sm btn-outline-secondary chart-action-btn toggle-dist-btn" data-target="${idSafe}">Show Distribution</button>`;
        }
        html+=`<div class="collapse show" id="collapse-${idSafe}">`;

        /* ------- TABLE ------- */
        html+=`<div class="table-responsive view-${idSafe}-table"><table id="table-${idSafe}" class="table table-bordered table-striped"><thead class="${colors[group]||'table-primary'}">`;
        if(isTMS){html+='<tr><th>Node</th><th>Method</th><th>Value</th></tr></thead><tbody>';
            const nodes=[...new Set(entries.map(e=>e['Node Name']))];
            nodes.forEach(node=>{
                const rows=entries.filter(e=>e['Node Name']===node);
                rows.forEach((entry,i)=>{
                    const v=entry.Value===1?'✅':'❌';
                    html+=`<tr>${i==0?`<td rowspan="${rows.length}">${node}</td>`:''}<td>${entry['Pathogen Testing Method']}</td><td>${v}</td></tr>`;
                });
            });
        }else{
            const hasNode=entries.some(e=>e['Node Name']); const hasPTM=entries.some(e=>e['Pathogen Testing Method']);
            html+='<tr><th>Variable</th>'+ (hasNode?'<th>Node</th>':'') + (hasPTM?'<th>Method</th>':'') +'<th>Value</th></tr></thead><tbody>';
            entries.forEach(e=>{const v=e.Value===1?'✅':e.Value===0?'❌':e.Value; html+=`<tr><td>${e['Variable Name']}</td>${hasNode?`<td>${e['Node Name']||''}</td>`:''}${hasPTM?`<td>${e['Pathogen Testing Method']||''}</td>`:''}<td>${v}</td></tr>`;});
        }
        html+='</tbody></table></div>';

        /* ------- CHART HOLDERS ------- */
        html+=`<div class="chart-container d-none view-${idSafe}-chart"><canvas id="chart-${idSafe}"></canvas></div>`;
        if(isBool && boolGroups.includes(group)){
            html+=`<div class="chart-container d-none view-${idSafe}-dist"><canvas id="dist-${idSafe}"></canvas></div>`;
        }
        html+='</div></div>';
        container.insertAdjacentHTML('beforeend',html);

        /* ------- AFTER RENDER ------- */
        setTimeout(()=>{
            if(!isTMS) new DataTable(`#table-${idSafe}`,{dom:'frtip',pageLength:8});
            /* ---- MAIN CHART ---- */
            const ctx=document.getElementById(`chart-${idSafe}`).getContext('2d');
            let labels=[],datasets=[];
            if(isTMS){
                const nodes=[...new Set(entries.map(e=>e['Node Name']))];
                const methods=[...new Set(entries.map(e=>e['Pathogen Testing Method']))];
                methods.forEach((m,i)=>datasets.push({label:m, data:nodes.map(n=>{const rec=entries.find(e=>e['Node Name']===n&&e['Pathogen Testing Method']===m);return rec?rec.Value:0;}), backgroundColor:palette[i%palette.length],stack:'combined'}));
                labels=nodes;
            }else if(isBool){
                const hasNode=entries.some(e=>e['Node Name']);
                if(hasNode){labels=entries.map(e=>e['Node Name']||''); datasets=[{label:'Status',data:entries.map(e=>e.Value), backgroundColor:entries.map(v=>v.Value===1?'rgba(40,167,69,0.75)':'rgba(220,53,69,0.75)')}];}
                else{labels=['True','False']; const t=entries.filter(e=>e.Value===1).length; const f=entries.length-t; datasets=[{label:'Count',data:[t,f],backgroundColor:['rgba(40,167,69,0.75)','rgba(220,53,69,0.75)']}];}
            }else{
                labels=entries.map(e=>e['Variable Name']); datasets=[{label:group,data:entries.map(e=>parseFloat(e.Value)||0),backgroundColor:palette[order%palette.length]}];
            }
            new Chart(ctx,{type:(isTMS?'bar':(isBool&&!entries.some(e=>e['Node Name'])?'doughnut':'bar')),data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:true},legend:{display:true}},scales:isTMS?{x:{stacked:true},y:{stacked:true,beginAtZero:true}}:{y:{beginAtZero:true}}}});

            /* ---- DISTRIBUTION CHART ---- */
            if(isBool && boolGroups.includes(group)){
                const dctx=document.getElementById(`dist-${idSafe}`).getContext('2d');
                const t=entries.filter(e=>e.Value===1).length;
                const f=entries.length-t;
                new Chart(dctx,{type:'doughnut',data:{labels:['True','False'],datasets:[{data:[t,f],backgroundColor:['rgba(40,167,69,0.85)','rgba(220,53,69,0.85)']} ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}});
                // reveal dist toggle button
                document.querySelector(`.toggle-dist-btn[data-target="${idSafe}"]`).classList.remove('d-none');
            }
        },100+order*40);
        order++;
    }
});
</script>
{% endblock %}
